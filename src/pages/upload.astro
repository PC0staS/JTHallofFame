---
import Layout from '../layouts/Layout.astro';
import UploadComponent from '../components/Upload.tsx';

export const prerender = false;

const auth = Astro.locals.auth();
const userId = auth.userId;

// Verificar que el usuario esté autenticado
if (!userId) {
  return Astro.redirect('/');
}

// Obtener información detallada del usuario usando la API
let userName = `user-${userId.slice(-8)}`;
try {
  const response = await fetch(`${Astro.url.origin}/api/user-simple`, {
    headers: {
      'Cookie': Astro.request.headers.get('Cookie') || ''
    }
  });
  
  if (response.ok) {
    const userData = await response.json();
    userName = userData.displayName || userName;
  }
} catch (error) {
  console.error('Error fetching user data:', error);
}
---

<Layout title="Subir Imagen - Galería de Memes">
	<UploadComponent 
		client:load 
		userId={userId} 
		userName={userName} 
	/>
</Layout>
